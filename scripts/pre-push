#!/bin/bash

# Pre-push hook to run CI checks locally
# This prevents pushing if CI checks would fail
#
# Note: Backend tests require docker-compose postgres to be running
# Run: docker-compose up -d db

set -e

echo "ğŸ” Running pre-push CI checks..."
echo ""

# Check if docker-compose postgres is running
if ! docker ps --filter "name=pandemic-vibe-db" --format "{{.Names}}" | grep -q "pandemic-vibe-db"; then
  echo "âš ï¸  Warning: Docker postgres container not running"
  echo "   Backend tests will fail without the database"
  echo "   Run: docker-compose up -d db"
  echo ""
fi

# Track if any checks fail
FAILED=0

# Backend checks
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ Backend Checks"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cd server

# Check formatting
echo "ğŸ“ Checking Elixir formatting..."
if ! mix format --check-formatted; then
  echo "âŒ Elixir formatting check failed!"
  echo "   Run: cd server && mix format"
  FAILED=1
else
  echo "âœ… Elixir formatting passed"
fi

# Compile with warnings as errors
echo "ğŸ”¨ Compiling Elixir with warnings as errors..."
if ! mix compile --warnings-as-errors; then
  echo "âŒ Elixir compilation failed!"
  FAILED=1
else
  echo "âœ… Elixir compilation passed"
fi

# Seed test database
echo "ğŸŒ± Seeding test database..."
if ! PGPORT=5433 mix run priv/repo/seeds.exs; then
  echo "âŒ Database seeding failed!"
  FAILED=1
else
  echo "âœ… Database seeding passed"
fi

# Run tests (use docker-compose postgres on port 5433)
echo "ğŸ§ª Running Elixir tests..."
if ! PGPORT=5433 mix test; then
  echo "âŒ Elixir tests failed!"
  FAILED=1
else
  echo "âœ… Elixir tests passed"
fi

cd ..

# Frontend checks
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš›ï¸  Frontend Checks"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cd frontend

# Run linter
echo "ğŸ” Running ESLint..."
if ! npm run lint; then
  echo "âŒ ESLint failed!"
  FAILED=1
else
  echo "âœ… ESLint passed"
fi

# Type check
echo "ğŸ“˜ Running TypeScript type check..."
if ! npx tsc --noEmit; then
  echo "âŒ TypeScript type check failed!"
  FAILED=1
else
  echo "âœ… TypeScript type check passed"
fi

# Build
echo "ğŸ—ï¸  Building frontend..."
if ! npm run build; then
  echo "âŒ Frontend build failed!"
  FAILED=1
else
  echo "âœ… Frontend build passed"
fi

cd ..

# Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 0 ]; then
  echo "âœ… All pre-push checks passed!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  exit 0
else
  echo "âŒ Pre-push checks failed!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Fix the errors above before pushing."
  echo "To skip this check (not recommended), use: git push --no-verify"
  exit 1
fi
