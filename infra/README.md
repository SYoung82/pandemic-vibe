# Infrastructure Documentation

This directory contains infrastructure configuration and documentation for deploying the Pandemic Vibe application.

## Directory Structure

```
infra/
├── README.md                  # This file - infrastructure overview
├── CI_CD_GUIDE.md            # Detailed CI/CD documentation
├── docker/
│   ├── Dockerfile.backend    # Multi-stage backend production build
│   └── Dockerfile.frontend   # Multi-stage frontend production build
├── fly/                      # Future Fly.io deployment configs
└── scripts/                  # Deployment and testing scripts
```

## CI/CD Pipeline

The project uses GitHub Actions for continuous integration. See [CI_CD_GUIDE.md](./CI_CD_GUIDE.md) for detailed documentation.

### Workflows

- **backend-ci.yml**: Tests, lints, and builds the Elixir/Phoenix backend
- **frontend-ci.yml**: Tests, lints, type-checks, and builds the React frontend
- **ci.yml**: Combined workflow providing a single status check

### Running CI Locally

**Backend:**
```bash
cd server

# Run tests
mix test

# Check formatting
mix format --check-formatted

# Compile with warnings as errors
mix compile --warnings-as-errors

# Production build
MIX_ENV=prod mix deps.get --only prod
MIX_ENV=prod mix compile
```

**Frontend:**
```bash
cd frontend

# Run tests (when configured)
npm test

# Lint
npm run lint

# Type check
npx tsc --noEmit

# Build
npm run build
```

## Docker Production Builds

### Backend

The backend Dockerfile creates a minimal production release using multi-stage builds:

**Build:**
```bash
cd /Users/syoung/dev/pandemic-vibe
docker build -f infra/docker/Dockerfile.backend -t pandemic-backend:latest ./server
```

**Environment Variables Required:**
- `DATABASE_URL` - PostgreSQL connection string
- `SECRET_KEY_BASE` - Phoenix secret key
- `PHX_HOST` - Application hostname
- `PORT` - Server port (default: 4000)

**Run locally:**
```bash
docker run -p 4000:4000 \
  -e DATABASE_URL="postgresql://user:pass@host:5432/dbname" \
  -e SECRET_KEY_BASE="your-secret-key-base" \
  -e PHX_HOST="localhost" \
  pandemic-backend:latest
```

### Frontend

The frontend Dockerfile builds the React app and serves it with nginx:

**Build:**
```bash
cd /Users/syoung/dev/pandemic-vibe
docker build -f infra/docker/Dockerfile.frontend -t pandemic-frontend:latest ./frontend
```

**Run locally:**
```bash
docker run -p 8080:80 pandemic-frontend:latest
```

The frontend will be available at `http://localhost:8080`.

## Deployment to Fly.io (Future)

### Prerequisites

1. Install Fly CLI:
   ```bash
   curl -L https://fly.io/install.sh | sh
   ```

2. Authenticate:
   ```bash
   fly auth login
   ```

### Backend Setup

1. **Generate Phoenix release configuration** (already done):
   ```bash
   cd server
   mix phx.gen.release
   ```

2. **Create Fly app**:
   ```bash
   fly apps create pandemic-vibe-backend
   ```

3. **Provision PostgreSQL**:
   ```bash
   fly postgres create --name pandemic-vibe-db
   fly postgres attach pandemic-vibe-db --app pandemic-vibe-backend
   ```

4. **Set secrets**:
   ```bash
   # Generate a secret key
   mix phx.gen.secret

   # Set it in Fly
   fly secrets set SECRET_KEY_BASE="your-generated-secret" --app pandemic-vibe-backend
   ```

5. **Deploy**:
   ```bash
   fly deploy --dockerfile infra/docker/Dockerfile.backend --app pandemic-vibe-backend
   ```

6. **Run migrations**:
   ```bash
   fly ssh console --app pandemic-vibe-backend
   /app/bin/migrate
   ```

### Frontend Setup

1. **Create Fly app**:
   ```bash
   fly apps create pandemic-vibe-frontend
   ```

2. **Deploy**:
   ```bash
   fly deploy --dockerfile infra/docker/Dockerfile.frontend --app pandemic-vibe-frontend
   ```

### Environment Configuration

**Backend environment variables:**
- `DATABASE_URL` - Automatically set by Fly when attaching Postgres
- `SECRET_KEY_BASE` - Generated with `mix phx.gen.secret`
- `PHX_HOST` - Your Fly.io hostname (e.g., `pandemic-vibe-backend.fly.dev`)
- `PORT` - Set to `8080` (Fly.io default)
- `POOL_SIZE` - Database connection pool size (default: 10)

**Frontend environment variables:**
- `VITE_API_URL` - Backend API URL (e.g., `https://pandemic-vibe-backend.fly.dev`)
- `VITE_WS_URL` - WebSocket URL (e.g., `wss://pandemic-vibe-backend.fly.dev/socket`)

## Database Migrations

### Development

```bash
cd server
mix ecto.migrate
```

### Production (Fly.io)

Migrations are run via the release script generated by `mix phx.gen.release`:

```bash
fly ssh console --app pandemic-vibe-backend
/app/bin/migrate
```

To rollback:
```bash
fly ssh console --app pandemic-vibe-backend
/app/bin/pandemic_vibe_server eval "PandemicVibeServer.Release.rollback(PandemicVibeServer.Repo, 1)"
```

## Monitoring and Debugging

### View Logs

**Fly.io:**
```bash
# Backend logs
fly logs --app pandemic-vibe-backend

# Frontend logs
fly logs --app pandemic-vibe-frontend
```

### SSH Access

```bash
# Backend
fly ssh console --app pandemic-vibe-backend

# Frontend
fly ssh console --app pandemic-vibe-frontend
```

### Health Checks

**Backend:**
```bash
curl https://pandemic-vibe-backend.fly.dev/api/health
```

**Frontend:**
```bash
curl https://pandemic-vibe-frontend.fly.dev/health
```

## Scaling

### Fly.io Scaling

**Increase instances:**
```bash
fly scale count 2 --app pandemic-vibe-backend
```

**Change VM size:**
```bash
fly scale vm shared-cpu-1x --app pandemic-vibe-backend
```

**Auto-scaling:**
```toml
# In fly.toml
[autoscaling]
  min_count = 1
  max_count = 5
```

## Troubleshooting

### Backend Issues

**Database connection errors:**
- Verify `DATABASE_URL` is set correctly
- Check Postgres app is running: `fly status --app pandemic-vibe-db`
- Ensure migrations are up to date

**Application won't start:**
- Check logs: `fly logs --app pandemic-vibe-backend`
- Verify `SECRET_KEY_BASE` is set
- Ensure `PHX_HOST` matches your domain

### Frontend Issues

**API connection errors:**
- Verify `VITE_API_URL` points to backend
- Check CORS configuration in backend
- Ensure backend is accessible

**Build errors:**
- Check Node version (should be 24)
- Verify all dependencies are installed
- Clear node_modules and rebuild

## Security Considerations

1. **Secrets Management**
   - Never commit secrets to git
   - Use Fly secrets for sensitive data
   - Rotate `SECRET_KEY_BASE` periodically

2. **Database Access**
   - Restrict Postgres to private network
   - Use SSL for database connections
   - Regular backups (Fly does this automatically)

3. **CORS Configuration**
   - Configure allowed origins in backend
   - Don't use wildcard (*) in production

4. **HTTPS**
   - Fly.io provides automatic SSL
   - Enforce HTTPS redirects

## Cost Optimization

### Fly.io Free Tier

- 3 shared VMs (1x 256MB RAM)
- 3GB storage
- 160GB outbound data transfer

**Recommendations:**
- Start with 1 VM for each app (backend, frontend)
- Use shared-cpu-1x for development
- Scale up based on actual usage

## Backup and Recovery

### Database Backups (Fly.io)

Automatic daily backups are enabled by default.

**Manual backup:**
```bash
fly postgres backup --app pandemic-vibe-db
```

**List backups:**
```bash
fly postgres backups list --app pandemic-vibe-db
```

**Restore:**
```bash
fly postgres restore <backup-id> --app pandemic-vibe-db
```

## Support

For issues:
- Check [CI/CD Guide](./CI_CD_GUIDE.md)
- Review Fly.io docs: https://fly.io/docs/
- Open GitHub issue
